name: Docs Quality

on:
  push:
    branches: [main, master, develop]
    paths:
      - "README.md"
      - "CONTRIBUTING.md"
      - "docs/**"
      - "core/sovereign/**"
      - "core/proof_engine/**"
      - "core/pci/**"
      - "bizra-omega/bizra-api/**"
      - "deploy/**"
      - "schemas/**"
      - ".github/workflows/**"
  pull_request:
    branches: [main, master]
    paths:
      - "README.md"
      - "CONTRIBUTING.md"
      - "docs/**"
      - "core/sovereign/**"
      - "core/proof_engine/**"
      - "core/pci/**"
      - "bizra-omega/bizra-api/**"
      - "deploy/**"
      - "schemas/**"
      - ".github/workflows/**"
  workflow_dispatch:

concurrency:
  group: docs-quality-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  docs-quality:
    runs-on: ubuntu-24.04
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5
        with:
          python-version: "3.12"

      - name: Set up Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4
        with:
          node-version: "20"

      - name: Install Markdown lint tooling
        run: npm install -g markdownlint-cli2

      - name: Determine changed files
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            git fetch origin "${{ github.base_ref }}" --depth=1
            git diff --name-only "origin/${{ github.base_ref }}...HEAD" > .changed_files.txt
          elif git rev-parse HEAD~1 >/dev/null 2>&1; then
            git diff --name-only HEAD~1 HEAD > .changed_files.txt
          else
            git ls-files > .changed_files.txt
          fi
          echo "Changed file count: $(wc -l < .changed_files.txt)"

      - name: Run documentation policy checks
        run: |
          python scripts/ci_docs_quality.py --changed-files .changed_files.txt

      - name: Lint canonical markdown docs
        run: |
          markdownlint-cli2 \
            README.md \
            CONTRIBUTING.md \
            docs/README.md \
            docs/OPERATIONS_RUNBOOK.md \
            docs/TESTING.md \
            docs/internal/DOCS_INDEX.md

      - name: Check local links in canonical docs
        uses: lycheeverse/lychee-action@a8c4c7cb88f0c7386610c35eb25108e448569cb0  # v2
        with:
          args: >-
            --offline
            --no-progress
            --include-fragments
            README.md
            CONTRIBUTING.md
            docs/README.md
            docs/OPERATIONS_RUNBOOK.md
            docs/TESTING.md
            docs/internal/DOCS_INDEX.md
          fail: true
